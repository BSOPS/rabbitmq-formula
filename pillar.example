# -*- coding: utf-8 -*-
# vim: ft=yaml
---
values:
  nodes:
    default:
      clustered: false
      user: rabbit    # 'node' would make more sense here
      host: localhost  # short hostname of node to join to, not fqdn
      erlang_cookie: shared-value-for-all-cluster-members
      config:
        listeners.tcp.1: 0.0.0.0:5672
        # auth_backends.1: ldap
        # auth_backends.2: internal
        # auth_ldap.servers.1: ldap.eng.megacorp.local
        # auth_ldap.servers.2: 192.168.0.100
        # auth_ldap.user_dn_pattern: cn=${username},ou=People,dc=example,dc=com
        # auth_ldap.use_ssl: false
        # auth_ldap.port: 389
        # auth_ldap.log: false
      service: true
      plugins:
        - rabbitmq_management
        - rabbitmq_federation
        - rabbitmq_federation_management
        # rabbitmq_auth_backend_ldap
      vhosts:
        - test_vhost
      users: {}
      policy:
        rabbitmq_policy:
          - name: HA
          - pattern: '.*'
          - definition: '{"ha-mode": "all"}'
      queues:
        my-new-queue:
          ## note : dict format
          user: saltstack
          passwd: password
          durable: true
          auto_delete: false
          vhost: test_vhost
          arguments:
            - x-message-ttl: 8640000
            - x-expires: 8640000
            - x-dead-letter-exchange: my-new-exchange
      upstreams:
        upstream_1:
          - uri: amqp://saltstack:password@localhost
          - trust_user_id: true
          - ack_mode: on-confirm
          - max_hops: 1
      users:
        user1:
          - password: password
          - force: true
          - tags: monitoring, user
          - perms:
              - '/':
                  - '.*'
                  - '.*'
                  - '.*'
          - runas: root
        user2:
          - password: password
          - force: true
          - tags: monitoring, user
          - perms:
              - '/':
                  - '.*'
                  - '.*'
                  - '.*'
          - runas: root
        saltstack:
          - password: password
          - force: false
          - tags:
              - administrator
          - perms:
              - test_vhost:
                  - '.*'
                  - '.*'
                  - '.*'
          - runas: root

  environ:
    # https://www.rabbitmq.com/configure.html#supported-environment-variables
    rabbitmq_mnesia_dir: /var/lib/rabbitmq

  ## todo: add support for ...
  binding:
    my-new-binding:
      - destination_type: queue
      - destination: my-new-queue
      - routing_key: a_routing_key_string
      - user: saltstack
      - passwd: 'password'
      - vhost: test_vhost
      - arguments:
          - 'x-message-ttl': 8640000

  exchange:
    my-new-exchange:
      - user: saltstack
      - passwd: 'password'
      - type: fanout
      - durable: true
      - internal: false
      - auto_delete: false
      - vhost: test_vhost
      - arguments:
          - 'alternate-**exchange': 'amq.fanout'
          - 'test-header': 'testing'

  tofs:
    # The files_switch key serves as a selector for alternative
    # directories under the formula files directory. See TOFS pattern
    # doc for more info.
    # Note: Any value not evaluated by `config.get` will be used literally.
    # This can be used to set custom paths, as many levels deep as required.
    files_switch:
      - any/path/can/be/used/here
      - id
      - roles
      - osfinger
      - os
      - os_family
    # All aspects of path/file resolution are customisable using the options below.
    # This is unnecessary in most cases; there are sensible defaults.
    # Default path: salt://< path_prefix >/< dirs.files >/< dirs.default >
    #         I.e.: salt://rabbitmq/files/default
    # path_prefix: template_alt
    # dirs:
    #   files: files_alt
    #   default: default_alt
    # The entries under `source_files` are prepended to the default source files
    # given for the state
    # source_files:
    #   rabbitmq-config-file-file-managed:
    #     - 'example_alt.tmpl'
    #     - 'example_alt.tmpl.jinja'

    # For testing purposes
    source_files:
      rabbitmq-config-file-file-managed:
        - 'example.tmpl.jinja'

  # Just for testing purposes
  winner: pillar
  added_in_pillar: pillar_value
